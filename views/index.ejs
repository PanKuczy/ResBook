<%- include('partials/header.ejs'); -%>
    <div class="container">
    <!-- DELETE FORM UNIVERSAL -->
        <form id="delete-form" method="post" style="display:none;">
            <input type="hidden" name="delete_item_id" value="">
            <input type="hidden" name="delete_item_DOMid" value="">
            <input type="hidden" name="delete_item_DOMid_additional" value="">
            <input type="hidden" name="delete_resource_id" value="">
            <input type="hidden" name="delete_route" value="">
        </form>

        <%- include('partials/categories_bar.ejs'); -%>


        <div class="box" id="main-content">
            <% // console.log(resources);%>

            <% for(let item of resources){%>
                <% const resourceIndex = resources.indexOf(item); %>
    <!-- BOOK -->
            <div class="user-book deletable-item visible" id="resource-id-<%= item?.resource_id %>" data-id="<%= item?.resource_id %>">
                <a class="book-heading" style="display: flex;" onclick="filterResources(null, null, <%= item?.resource_id %>)">

                    <div class="book-cover">
                        <img src="<%= item?.cover_url ?? null %>">
                    </div>
                    <div class="book-heading-text">
                        <div class="book-categories-row"> <!-- CATEGORIES -->
                            <% for(let cat of item?.resource_categories){ %>
                                <span class="single-category book-with-category-<%=cat?.category_id %> visible-horizontal" id="book-<%= item?.resource_id %>-cat-<%=cat?.category_id %>" data-id="<%=cat?.category_id %>" draggable="true"><%=cat?.category_name %></span>
                            <%}%>
                        </div>
                        
                        <h2 class="book-title"><%= item.resource_title %></h2>
                        <h3 class="book-subtitle"><%= item?.subtitle ?? null %></h3>
                        <div class="book-authors-date-place-row">
                            <div class="authors-date-place-group"><h5 class="author-text">By </h5><h5 class="author-text"><%= item.authors %></h5></div>
                            <div class="authors-date-place-group">
                                <h5 class="year-text"><%= item?.publication_year ?? null -%></h5><h5 class="place-text"><%if(item?.place){%>,<% } %>
                                <%- item?.place ?? null -%></h5>
                            </div>
                        </div>
                    </div>
                    <div class="right-stripe"></div>
                </a>
                <!-- editable -->
                <div class="book-heading editable" style="display: none;">

                    <div class="book-cover">
                        <img src="<%= item?.cover_url ?? null %>">
                    </div>
                    <div class="book-heading-text">
                        
                        <h2 class="book-title editable">Title: <input value="<%= item.resource_title %>"><h2>
                        <h3 class="book-subtitle editable">Subtitle: <input value="<%= item?.subtitle ?? null %>"></h3>
                        <div class="book-authors-date-place-row">
                            <div class="authors-date-place-group"><h5 class="author-text editable">Authors: <input value="<%= item.authors %>"></h5></div>
                            <div class="authors-date-place-group">
                                <h5 class="year-text editable">Year: <input value="<%= item?.publication_year ?? null -%>"></h5><h5 class="place-text editable">Place: <input value="<%- item?.place ?? null -%>"></h5>
                            </div>
                        </div>
                    </div>
                    <div class="right-stripe"></div>

                </div>

                <div class="book-heading-buttons">
                    <button 
                        class="icon-button tooltip-container edit-toggle-button" 
                        type="edit" 
                        name="edit-resource" 
                        onclick="editResourceToggle(this, <%= item?.resource_id ?? null %>)">
                        <i class="fa-solid fa-file-pen"></i><span class="tooltip">edit resource</span>
                    </button>
                    <button 
                        disabled
                        class="icon-button tooltip-container edit-submit-button"
                        type="button"
                        name="edit-resource-submit" 
                        onclick="editResourceToggle(this, <%= item?.resource_id ?? null %>)">
                        <i class="fa-solid fa-floppy-disk"></i><span class="tooltip">save changes</span>
                    </button>
                    <button 
                        disabled
                        class="icon-button tooltip-container edit-cancel-button" 
                        type="button" 
                        name="edit-resource-cancel" 
                        onclick="editResourceToggle(this, <%= item?.resource_id ?? null %>)">
                        <i class="fa-solid fa-rotate-left"></i><span class="tooltip">discard changes</span>
                    </button>
                    <button 
                        class="delete-button icon-button tooltip-container" 
                        id="delete-resource-<%= item?.resource_id ?? null %>"
                        type="button"
                        onclick="showConfirmationPopup(null, '/delete-resource', '<%= item?.resource_id %>', 'resource-id-<%= item?.resource_id %>', null)">
                        <i class="fa-solid fa-trash"></i><span class="tooltip">delete resource</span>
                    </button>
                </div>
                <div class="resource-expand">
                    <button class="icon-button" onclick="toggleResource(<%= item?.resource_id %>)" type="button"><i id="toggle-notes-icon-<%= item?.resource_id %>" class="fa-solid fa-circle-chevron-down"></i></button>
                </div>
    <!-- NOTES     -->
     
                <div class="notes-box hidden" id="notesbox-<%= item?.resource_id %>">
                    <div class="notes-box-heading">
                        <h4><span>Notes <span><button class="icon-button tooltip-container" type="add" name="add-note" onclick="newNoteRolloutToggle('<%= item?.resource_id %>')"><i class="fa-solid fa-square-plus"></i><span class="tooltip">create new note</span></button></span></span> <span class="notes-sortby">Sort by:</span></h4>
        <!-- ADD NOTE -->
                        <form class="new-note hidden" action="/add-note" method="post" id="add-new-note-<%= item?.resource_id %>">
                            <div class="new-note-box">
                                <button class="new-note-tag-rollout-button" onclick="selectTagsRolloutToggle(this, <%= item?.resource_id %>, null)" type="button">Select Tags <i id="triangle-icon-<%= item?.resource_id %>" class="fa-solid fa-square-caret-right"></i></button>
                                <div id="tag-rollout-<%= item?.resource_id %>" class="tag-rollout-drawer hidden-fast">
                                    <div class="heading-with-buttons">
                                        <h4>Assign Note Tags:</h4>
                                        <div>
                                            <button 
                                            class="icon-button tooltip-container edit-tags-toggle-button" 
                                            type="button"
                                            name="edit-tags-toggle" 
                                            onclick="editTagsToggle(<%= item?.resource_id %>, null)">
                                            <i class="fa-solid fa-file-pen"></i><span class="tooltip">edit tags</span>
                                            </button>
                                            <button 
                                            disabled
                                            class="icon-button tooltip-container edit-tags-submit-button"
                                            type="button"
                                            name="edit-tags-submit" 
                                            onclick="editTagsSubmit(this)">
                                            <i class="fa-solid fa-floppy-disk"></i><span class="tooltip">save changes</span>
                                            </button>
                                            <button 
                                            disabled
                                            class="icon-button tooltip-container edit-tags-cancel-button" 
                                            type="button" 
                                            name="edit-tags-cancel" 
                                            onclick="editTagsToggle(<%= item?.resource_id %>, null)">
                                            <i class="fa-solid fa-rotate-left"></i><span class="tooltip">discard changes</span>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="separator-2"></div>
    
                                    <div id="tag-container-<%= item?.resource_id %>" class="all-tags-row" style="display: flex;">
                                        <% tags.forEach(tag => { %>
                                            <span class="tag single-note-tags visible-horizontal" data-id="<%= tag.id %>" data-name="<%= tag.name %>" data-color="<%= tag.color %>" data-invert-color="<%= tag.invertColor %>" style="background-color: <%= tag.color %>; color: <%= tag.invertColor %>; border-color: <%= tag.invertColor %>" onclick="selectTag(this, <%= item?.resource_id %>)">
                                                <%= tag.name %>
                                            </span>
                                        <% }); %>
                                    </div>
                                    <div class="edit-tags-form">
                                        <div id="edit-tag-container-<%= item?.resource_id %>" class="all-tags-row" style="display: none;">
    
                                            <% tags.forEach(tag => { %>
                                                <div class="editable-tag-row tag single-note-tags visible-horizontal" data-name="<%= tag.name %>" data-id="<%= tag.id %>" data-color="<%= tag.color %>" data-invert-color="<%= tag.invertColor %>" style="background-color: <%= tag.color %>; color: <%= tag.invertColor %>; border-color: <%= tag.invertColor %>">
                                                    <input type="text" oninput="this.size = this.value.length" class="tag editable" value="<%= tag.name %>" style="background-color: <%= tag.color %>; color: <%= tag.invertColor %>;" >
                                                    </input>
                                                    <button 
                                                    class="icon-button color-selector-icon tooltip-container tag-color-<%= tag.id %>" 
                                                    data-jscolor="{value:'<%= tag.color %>'}"
                                                    type="button">
                                                    <span class="tooltip">change color</span>
                                                    </button>
                                                    <button 
                                                    class="delete-button icon-button tooltip-container delete-tag-<%= tag.id %>" 
                                                    type="button"
                                                    onclick="showConfirmationPopup('<%= tag.id %>', '/delete-tag', <%= item?.resource_id %>, null, null)">
                                                    <i class="fa-solid fa-trash"></i><span class="tooltip">delete tag</span>
                                                    </button>
                                                </div>
                                            <% }); %>
    
                                        </div>
                                    </div>
                                    <div class="add-new-tag-miniform">
                                        <input class="add-new-tag-input" type="text" placeholder="New tag name..." />
                                        <button class="color-selector-button" data-jscolor="{value:'#5ED8FF'}" >color</button>
                                        <button class="text-button" type="button" onclick="addTag(<%= item?.resource_id %>, null)">Add New Tag</button>
                                    </div>
                                    <input type="hidden" name="selectedTagIds" id="selectedNewNoteTags-<%= item?.resource_id %>" />
                                    <input type="hidden" name="selectedTagsNames" id="selectedNewNoteTagsNames-<%= item?.resource_id %>" />
                                    <input type="hidden" name="selectedTagsColors" id="selectedNewNoteTagsColors-<%= item?.resource_id %>" />
                                    <input type="hidden" name="selectedTagsColorsInv" id="selectedNewNoteTagsColorsInv-<%= item?.resource_id %>" />
                                </div>
    
                                
                                <textarea class="new-note-text" type="text" name="note_text" placeholder="New note..." autocomplete="off" autofocus="true" id="new-note-text-<%= item?.resource_id %>" required></textarea>
                                <div class="flex-end">
                                    <label for="new-note-link">Link: </label>
                                    <input class="input-link" type="text" name="target_object" placeholder="Link" autocomplete="off" autofocus="true" id="new-note-link-<%= item?.resource_id %>"/>
                                    <label for="new-note-pages">Pages: </label>
                                    <input class="input-pages" type="text" name="target_pages" placeholder="Pages" autocomplete="off" autofocus="true" id="new-note-pages-<%= item?.resource_id %>"/>

                                </div>
                                <input type="hidden" name="resource_id" value="<%= item.resource_id %>" />
                                <button class="text-button" type="submit" name="note-submit" onclick="submitNewNote('add-new-note-<%= item?.resource_id %>')" value="" >Submit</button>
                                <button class="text-button" type="reset" name="note-cancel" onclick="cancelNewNote('add-new-note-<%= item?.resource_id %>')" value="" >Cancel</button>
                            </div>
                        </form>
                    </div>
    <!-- ADD NOTE END -->
                    <!-- te dwie linijki są potrzebne żeby object był widziany jako array. Możliwe, że do wywalenia w przyszłości.  -->
                    <% let notesTagsCorelArray = [notes_tags_corel]; %>
                    <% notesTagsCorelArray = [...notes_tags_corel]; %> 

                    <% if (resources[resourceIndex]?.notes && resources[resourceIndex].notes.length > 0) { %>
                        <% for(let note of resources[resourceIndex]?.notes ?? null){%>
                            <div class="single-note-item deletable-item <%if (!note?.note_id){%><%='hidden'%><%}%>" id="note-id-<%= note?.note_id %>">
                                <% const filteredArray = notesTagsCorelArray.filter((id) => id.note_id == note.note_id ) %>
    <!-- NOTE HEADING -->
                                <div class="note-heading-row">
                                    <div class="note-date-del-edit-row">
                                        <button 
                                            class="icon-button tooltip-container" 
                                            type="edit" 
                                            name="edit-note" 
                                            onclick="editNoteToggle(this, <%= note?.note_id ?? null %>)">
                                            <i class="fa-solid fa-file-pen"></i><span class="tooltip">edit note</span>
                                        </button>
                                        <button 
                                            disabled
                                            class="icon-button tooltip-container edit-submit-button"
                                            type="button"
                                            name="edit-note-submit" 
                                            onclick="editNoteToggle(this, <%= note?.note_id ?? null %>)">
                                            <i class="fa-solid fa-floppy-disk"></i><span class="tooltip">save changes</span>
                                        </button>
                                        <button 
                                            disabled
                                            class="icon-button tooltip-container edit-cancel-button" 
                                            type="button" 
                                            name="edit-note-cancel" 
                                            onclick="editNoteToggle(this, <%= note?.note_id ?? null %>)">
                                            <i class="fa-solid fa-rotate-left"></i><span class="tooltip">discard changes</span>
                                        </button>
                                        <button 
                                            class="icon-button tooltip-container generate-citation-button" 
                                            type="button" 
                                            name="generate-citation" 
                                            onclick="generateCitation('<%= note?.note_id ?? null %>')">
                                        <i class="fa-solid fa-quote-right"></i><span class="tooltip">generate citation</span>
                                        </button>
                                        <button 
                                            class="delete-button icon-button tooltip-container" 
                                            id="delete-note-<%= note?.note_id ?? null %>"
                                            type="button"
                                            onclick="showConfirmationPopup('<%= note?.note_id ?? null %>', '/delete-note', '<%= item.resource_id %>', 'note-id-<%= note?.note_id %>', null)">
                                            <i class="fa-solid fa-trash"></i><span class="tooltip">delete note</span>
                                        </button>
                                        <p class="note-date" value="date" id="note-<%= note?.note_id ?? null %>-date"><%= note?.formattedDate ?? null %></p>

                                    </div>
    <!-- NOTE HEADING: TAGS -->
                                    <div class="note-tags-row">
                                        <button class="icon-button-tags tooltip-container" type="add" name="add-tag" onclick="selectTagsRolloutToggle(this, <%= item?.resource_id %>, <%= note?.note_id ?? null %>)">+<span class="tooltip">assign tags</span></button>
        <!-- ASSIGN TAGS ROLLOUT AND MINIFORM -->
                                        <div id="tag-rollout-<%= item?.resource_id %>-<%= note?.note_id ?? null %>" class="tag-rollout-drawer hidden-fast">
                                            <div class="heading-with-buttons">
                                                <h4>Assign Note Tags</h4>
                                                <div>
                                                    <button 
                                                    class="icon-button tooltip-container edit-tags-toggle-button" 
                                                    type="edit" 
                                                    name="edit-tags-toggle" 
                                                    onclick="editTagsToggle(<%= item?.resource_id %>, <%= note?.note_id ?? null %>)">
                                                    <i class="fa-solid fa-file-pen"></i><span class="tooltip">edit tags</span>
                                                    </button>
                                                    <button 
                                                    disabled
                                                    class="icon-button tooltip-container edit-tags-submit-button"
                                                    type="submit" 
                                                    name="edit-tags-submit" 
                                                    onclick="editTagsSubmit(this)">
                                                    <i class="fa-solid fa-floppy-disk"></i><span class="tooltip">save changes</span>
                                                    </button>
                                                    <button 
                                                    disabled
                                                    class="icon-button tooltip-container edit-tags-cancel-button" 
                                                    type="reset" 
                                                    name="edit-tags-cancel" 
                                                    onclick="editTagsToggle(<%= item?.resource_id %>, <%= note?.note_id ?? null %>)">
                                                    <i class="fa-solid fa-rotate-left"></i><span class="tooltip">discard changes</span>
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="separator-2"></div>

                                            <div id="tag-container-<%= item?.resource_id %>-<%= note?.note_id ?? null %>" class="all-tags-row" style="display: flex;">
                                                <% tags.forEach(tag => { %>
                                                    <span class="tag single-note-tags visible-horizontal" data-id="<%= tag.id %>" data-name="<%= tag.name %>" data-color="<%= tag.color %>" data-invert-color="<%= tag.invertColor %>" style="background-color: <%= tag.color %>; color: <%= tag.invertColor %>; border-color: <%= tag.invertColor %>" onclick="selectTag(this, <%= item?.resource_id %>, <%= note?.note_id ?? null %>)">
                                                        <%= tag.name %>
                                                    </span>
                                                <% }); %>
                                            </div>
        <!-- EDIT AND DELETE TAGS -->                                                
                                            <form class="edit-tags-form">
                                                <div id="edit-tag-container-<%= item?.resource_id %>-<%= note?.note_id ?? null %>" class="all-tags-row" style="display: none;">

                                                    <% tags.forEach(tag => { %>
                                                        <div class="editable-tag-row tag single-note-tags visible-horizontal" data-name="<%= tag.name %>" data-id="<%= tag.id %>" data-color="<%= tag.color %>" data-invert-color="<%= tag.invertColor %>" style="background-color: <%= tag.color %>; color: <%= tag.invertColor %>; border-color: <%= tag.invertColor %>">
                                                            <input type="text" oninput="this.size = this.value.length" class="tag editable" value="<%= tag.name %>" style="background-color: <%= tag.color %>; color: <%= tag.invertColor %>;" >
                                                            </input>
                                                            <button 
                                                            class="icon-button color-selector-icon tooltip-container tag-color-<%= tag.id %>" 
                                                            data-jscolor="{value:'<%= tag.color %>'}"
                                                            type="button">
                                                            <span class="tooltip">change color</span>
                                                            </button>
                                                            <button 
                                                            class="delete-button icon-button tooltip-container delete-tag-<%= tag.id %>" 
                                                            type="button"
                                                            onclick="showConfirmationPopup('<%= tag.id %>', '/delete-tag', <%= item?.resource_id %>, null, null)">
                                                            <i class="fa-solid fa-trash"></i><span class="tooltip">delete tag</span>
                                                            </button>
                                                        </div>
                                                    <% }); %>

                                                </div>
                                            </form>
        <!-- END EDIT AND DELETE TAGS -->

                                            <div class="add-new-tag-miniform">
                                                <input class="add-new-tag-input" type="text" placeholder="New tag name..." />
                                                <button class="color-selector-button" data-jscolor="{value:'#5ED8FF'}" >color</button>
                                                <button class="text-button" type="button" onclick="addTag(<%= item?.resource_id %>, <%= note?.note_id ?? null %>)">Add New Tag</button>
                                            </div>
                                            <div class="separator-2"></div>
                                            <div>
                                                <button class="text-button assign-tags-confirm" type="button" onclick="assignTags(this, <%= item?.resource_id %>, <%= note?.note_id ?? null %>)">Confirm Selection</button>
                                            </div>

                                        </div>
        <!-- ACTUAL NOTE TAGS  -->
                                        <% for(let tag of filteredArray){ %>
                                            <% const tagId = tag.tag_id; %>
                                            <% const filteredTags = tags.filter((item) => item.id == tagId ) %> 
                                            <span class="single-note-tags visible-horizontal" data-id="<%= tag.tag_id %>" data-name="<%= filteredTags[0].name %>" data-color="<%= filteredTags[0].color %>" data-invert-color="<%= filteredTags[0].invertColor %>" style="background-color: <%= filteredTags[0].color %>; color: <%= filteredTags[0].invertColor %>; border-color: <%= filteredTags[0].invertColor %>"><%= filteredTags[0].name %></span>
                                        <%}%>
                                    </div>
                                </div>
    <!-- NOTE TEXT -->
                                <div class="single-note-text" id="note-text-<%= note?.note_id ?? null %>">
                                    
                                    <p class="note-text-area" id="note-text-area-<%= note?.note_id ?? null %>" style="display: flex;"><%= note.note_text %></p>
                                    <textarea class="edit-note-textarea" id="note-text-area-edit-<%= note?.note_id ?? null %>" style="display: none;"><%= note.note_text %></textarea>
                                    <div class="note-bottom-row" style="display: flex;">
                                        <span class="single-note-targets target-link" id="note-target-object-<%= note?.note_id ?? null %>">
                                            <% if (note?.target_object) { %>
                                                Link: <a href="<%= note?.target_object %>" rel="noopener noreferrer" target="_blank"><%= note?.target_object %></a>
                                            <%}%>
                                        </span>
                                        <span class="single-note-targets target-pages" id="note-target-pages-<%= note?.note_id ?? null %>" data-content="<%= note?.target_pages ?? null %>">
                                            <% if (note?.target_pages) { %>
                                                Pages: <%= note.target_pages %>
                                            <% } %>
                                        </span>
                                    </div>
                                    <div class="note-bottom-row" style="display: none;">
                                        <span class="single-note-targets target-link" id="note-target-object-edit-<%= note?.note_id ?? null %>">
                                                Link: <input class="input-link" type="text" value="<%= note?.target_object ?? null %>">
                                        </span>
                                        <span class="single-note-targets target-pages" id="note-target-pages-edit-<%= note?.note_id ?? null %>">
                                                Pages: <input class="input-pages" type="text" value="<%= note.target_pages ?? null  %>">
                                        </span>
                                    </div>

                                </div>
                            </div>
                        <%}%>
                    <%}%>
                </div>
            </div>
            <% } %>

            <div id="confirmation-popup" style="display:none;">
                <div class="popup-content">
                    <p>Are you sure you want to delete this item?</p>
                    <button onclick="confirmDelete()">Yes</button>
                    <button onclick="cancelDelete()">Cancel</button>
                </div>
            </div>
            <div id="remove-popup" style="display:none; pointer-events: none;">
                <div class="remove-popup-content">
                    <button 
                    class="icon-button tooltip-container" 
                    id="remove-item-bucket"
                    type="button">
                    <i class="fa-solid fa-trash"style="pointer-events: none;"></i><span class="tooltip">remove item</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    


<%- include('partials/footer.ejs'); -%>